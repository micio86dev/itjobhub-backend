generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  // @prisma-ignore: Required for Prisma 6.x - will be removed in Prisma 7 upgrade
  url      = env("DATABASE_URL")
}

model User {
  id         String    @id @default(auto()) @map("_id") @db.ObjectId
  email      String    @unique
  password   String? // Optional for OAuth users
  first_name String
  last_name  String
  role       String    @default("user")
  created_at DateTime? @default(now())
  updated_at DateTime? @updatedAt

  // OAuth fields
  oauth_provider String? // 'github' | 'linkedin' | 'google'
  oauth_id       String? // Provider's unique user ID

  phone     String?
  location  String?
  bio       String?
  birthDate String?
  avatar    String?

  // Reset Password
  reset_password_token   String? // Removed @unique due to MongoDB null duplicate key error
  reset_password_expires DateTime?

  // Relations
  comments        Comment[]
  likes           Like[]
  profile         UserProfile?
  refresh_tokens  RefreshToken[]
  favorites       Favorite[]
  interactions    Interaction[]
  contact_replies ContactReply[] @relation("ContactReplies")
  contacts        Contact[]

  @@index([reset_password_token])
  @@map("users")
}

model Company {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  description   String?
  website       String?
  industry      String?
  size          String?
  location      String?
  logo          String?
  logo_url      String?
  trustScore    Float     @default(80.0)
  totalRatings  Int       @default(0)
  totalLikes    Int       @default(0)
  totalDislikes Int       @default(0)
  created_at    DateTime? @default(now())
  updated_at    DateTime? @updatedAt

  // Relations
  jobs Job[]

  @@map("companies")
}

model Seniority {
  id         String    @id @default(auto()) @map("_id") @db.ObjectId
  level      String    @unique
  created_at DateTime? @default(now())

  // Relations
  jobs Job[]

  @@map("seniorities")
}

type LocationGeo {
  type        String  @default("Point")
  coordinates Float[]
}

model Job {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId
  company_id        String?   @db.ObjectId
  seniority_id      String?   @db.ObjectId
  title             String
  description       String
  link              String?
  source            String?
  original_language String?
  language          String?
  published_at      DateTime?

  requirements String[]
  benefits     String[]
  salary_min   Int?
  salary_max   Int?

  location  String?
  remote    Boolean  @default(false)
  is_remote Boolean?

  formatted_address String?
  city              String?
  country           String?

  location_geo               LocationGeo?
  formatted_address_verified String?
  location_raw               String?

  employment_type  String?
  experience_level String?
  seniority        String?

  skills           String[]
  technical_skills String[]

  views_count  Int       @default(0)
  clicks_count Int       @default(0)
  status       String    @default("active")
  created_at   DateTime? @default(now())
  updated_at   DateTime? @updatedAt
  expires_at   DateTime?

  // Relations
  company       Company?   @relation(fields: [company_id], references: [id])
  seniority_ref Seniority? @relation(fields: [seniority_id], references: [id])
  favorites     Favorite[]

  @@map("jobs")
}

type NewsTranslation {
  language String // "it", "en", "es", "de", "fr"
  title    String
  summary  String?
  content  String?
}

model News {
  id           String            @id @default(auto()) @map("_id") @db.ObjectId
  title        String
  slug         String            @unique
  summary      String?
  content      String?
  source_url   String?
  image_url    String?
  category     String? // e.g., "AI", "IT", "Security"
  language     String? // "it", "en", etc. (original language)
  translations NewsTranslation[]
  is_published Boolean           @default(true)
  published_at DateTime?         @default(now())

  // Tracking stats
  views_count  Int @default(0)
  clicks_count Int @default(0)

  created_at DateTime? @default(now())
  updated_at DateTime? @updatedAt

  @@map("news")
}

model Comment {
  id               String    @id @default(auto()) @map("_id") @db.ObjectId
  commentable_id   String    @db.ObjectId
  commentable_type String // "job" | "news"
  user_id          String    @db.ObjectId
  content          String
  created_at       DateTime? @default(now())
  updated_at       DateTime? @updatedAt

  // Self-relation for threading
  parentId String?   @db.ObjectId
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replies  Comment[] @relation("CommentReplies")

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([commentable_id, commentable_type])
  @@map("comments")
}

model Like {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  user_id       String    @db.ObjectId
  likeable_type String // "job" | "news" | "comment"
  likeable_id   String    @db.ObjectId
  type          String    @default("LIKE") // "LIKE" | "DISLIKE"
  created_at    DateTime? @default(now())

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, likeable_type, likeable_id])
  @@map("likes")
}

model UserProfile {
  id           String       @id @default(auto()) @map("_id") @db.ObjectId
  user_id      String       @unique @db.ObjectId
  languages    String[]
  skills       String[]
  seniority    String?
  availability String?
  workModes    String[]
  salaryMin    Int?         @default(0)
  cv_url       String?
  bio          String?
  location     String?
  location_geo LocationGeo?
  github       String?
  linkedin     String?
  website      String?
  created_at   DateTime?    @default(now())
  updated_at   DateTime?    @updatedAt

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model RefreshToken {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  refresh_token String    @unique
  user_id       String    @db.ObjectId
  expires_at    DateTime
  created_at    DateTime? @default(now())

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model Favorite {
  id         String    @id @default(auto()) @map("_id") @db.ObjectId
  user_id    String    @db.ObjectId
  job_id     String    @db.ObjectId
  created_at DateTime? @default(now())

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
  job  Job  @relation(fields: [job_id], references: [id], onDelete: Cascade)

  @@unique([user_id, job_id])
  @@map("favorites")
}

model Interaction {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  trackable_id   String    @db.ObjectId
  trackable_type String // "job" | "news"
  user_id        String?   @db.ObjectId
  fingerprint    String?
  type           String // "VIEW" | "APPLY" | "CLICK"
  created_at     DateTime? @default(now())

  // Relations
  user User? @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([trackable_id, trackable_type, user_id, fingerprint, type])
  @@map("interactions")
}

model Contact {
  id                  String    @id @default(auto()) @map("_id") @db.ObjectId
  sender_id           String?   @db.ObjectId // Optional if not logged in
  sender_name         String
  sender_email        String
  subject             String
  message             String
  is_sender_logged_in Boolean   @default(false)
  created_at          DateTime  @default(now())
  updated_at          DateTime? @updatedAt

  // Relations
  user    User?          @relation(fields: [sender_id], references: [id], onDelete: SetNull)
  replies ContactReply[]

  @@index([sender_id])
  @@index([created_at])
  @@map("contacts")
}

model ContactReply {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  contact_id     String    @db.ObjectId
  replier_id     String    @db.ObjectId // Always admin
  message        String
  created_at     DateTime  @default(now())
  updated_at     DateTime? @updatedAt
  read_by_sender Boolean   @default(false)
  read_at        DateTime?

  // Relations
  contact Contact @relation(fields: [contact_id], references: [id], onDelete: Cascade)
  replier User    @relation("ContactReplies", fields: [replier_id], references: [id], onDelete: Cascade)

  @@index([contact_id])
  @@index([created_at])
  @@map("contact_replies")
}
